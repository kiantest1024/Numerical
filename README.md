# @numericalTools - 通用数值模拟验证工具

## 📋 项目概述

@numericalTools是一个专为游戏RTP验证需求设计的通用数值模拟验证工具。支持包含jackpot和未包含jackpot的各种游戏类型，提供高性能的大规模数值模拟和精确的RTP计算。

## 🎯 核心功能

### 游戏配置
- **多种游戏类型**: 支持彩票、刮刮乐、老虎机等多种游戏类型
- **灵活规则设置**: 自定义数字范围、选择数量、奖级配置
- **奖池机制**: 支持Jackpot设置，包括初始奖池、注入比例、返还比例
- **配置模板**: 提供预设模板，快速开始

### 数值模拟
- **高性能计算**: 基于NumPy和Pandas优化，支持百万级轮次模拟
- **参数化配置**: 模拟轮数、用户数范围、投注比数范围完全可配置
- **实时进度**: 模拟过程实时监控和进度反馈
- **随机性保证**: 高质量随机数生成，确保模拟公正性

### 结果分析
- **精确RTP计算**: 分别计算普通奖金RTP和Jackpot奖金RTP
- **统计分析**: 各奖级中奖人数、概率分析、趋势分析
- **可视化展示**: 丰富的图表展示，包括RTP趋势、奖级分布等
- **报告导出**: 支持HTML、Excel、JSON格式报告导出

## 🏗️ 技术架构

### 后端 (FastAPI + Python)
- **框架**: FastAPI - 高性能异步Web框架
- **数值计算**: NumPy, Pandas - 高效数值计算和数据处理
- **模拟引擎**: 自研通用模拟引擎，支持多种游戏类型
- **API设计**: RESTful API，支持实时进度推送

### 前端 (React)
- **框架**: React 18 - 现代化前端框架
- **UI组件**: Ant Design - 企业级UI设计语言
- **可视化**: Chart.js, Plotly.js - 专业图表库
- **状态管理**: React Hooks - 简洁的状态管理

### 部署
- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **跨平台**: 支持Windows、Linux、macOS

## 🚀 快速开始

### 环境要求
- Docker 20.0+
- Docker Compose 2.0+
- 或者：Python 3.11+, Node.js 18+

### Docker部署（推荐）

1. **克隆项目**
```bash
git clone <repository-url>
cd numericalTools
```

2. **启动服务**
```bash
docker-compose up -d
```

3. **访问应用**
- 前端界面: http://localhost:3000
- 后端API: http://localhost:8000
- API文档: http://localhost:8000/docs

### 本地开发

1. **后端启动**
```bash
cd backend
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

2. **前端启动**
```bash
cd frontend
npm install
npm start
```

## 📖 使用指南

### 方式一：使用已保存配置

#### 1. 选择配置
- 在"运行模拟"页面选择"使用已保存配置"标签
- 从下拉列表中选择已保存的配置
- 点击"启动模拟"开始运行

#### 2. 监控进度
- 实时查看模拟进度和状态
- 监控RTP变化趋势
- 查看中奖和未中奖人数统计
- 观察奖池变化和头奖中出情况

#### 3. 结果分析
- 查看汇总统计数据
- 分析RTP趋势和变化
- 查看各奖级详细统计
- 导出分析报告

### 方式二：创建新配置并运行

#### 1. 基础游戏配置
- 在"运行模拟"页面选择"创建新配置并运行"标签
- 填写游戏名称和描述
- 设置数字范围上限（如42选6中的42）
- 设置选择数量（如42选6中的6）
- 设置单注价格

#### 2. 模拟参数配置
- 设置模拟轮数（建议100-1000轮）
- 设置每轮玩家数量范围
- 设置每个玩家投注次数范围
- 可选设置随机种子（用于结果重现）

#### 3. 奖池配置（可选）
- 启用/禁用奖池机制
- 设置初始奖池金额
- 配置第一阶段奖池注入比例
- 配置第二阶段奖池注入比例
- 设置销售方返还比例
- 可选设置头奖固定奖金
- 设置最小奖池金额

#### 4. 启动和监控
- 点击"启动模拟"直接开始运行
- 实时监控模拟进度和统计数据
- 查看奖池重置和分阶段转换
- 监控未中奖人数统计

### 实时监控功能

#### 玩家统计
- **总玩家数**: 累计参与的玩家总数
- **中奖人数**: 累计中奖的玩家数量
- **未中奖人数**: 累计未中奖的玩家数量
- **中奖率**: 中奖人数占总玩家数的比例

#### 资金统计
- **总投注金额**: 累计投注金额
- **总派奖金额**: 累计派奖金额
- **当前RTP**: 实时返奖率
- **奖池余额**: 当前奖池金额
- **销售金额**: 累计销售金额

#### 奖池监控
- **头奖中出次数**: 累计头奖中出次数
- **奖池阶段**: 当前处于第一阶段还是第二阶段
- **销售方返还**: 累计销售方返还金额
- **阶段转换**: 实时监控阶段转换状态

#### 奖级分布
- **各奖级中奖人数**: 实时显示各奖级中奖情况
- **各奖级总奖金**: 累计各奖级派发的总奖金
- **RTP趋势**: 最近轮次的RTP变化趋势

## 🔧 配置说明

### 游戏规则配置

#### 基础配置
```json
{
  "game_type": "lottery",
  "name": "42选6彩票",
  "description": "经典42选6数字彩票游戏",
  "number_range": [1, 42],
  "selection_count": 6,
  "ticket_price": 20.0
}
```

#### 奖级配置
奖级配置支持两种奖金模式：

**1. 固定奖金模式**
```json
{
  "level": 2,
  "name": "二等奖",
  "match_condition": 5,
  "fixed_prize": 10000.0,
  "prize_percentage": null
}
```

**2. 比例奖金模式**
```json
{
  "level": 1,
  "name": "一等奖",
  "match_condition": 6,
  "fixed_prize": null,
  "prize_percentage": 0.9
}
```

#### 完整奖级配置示例
```json
{
  "prize_levels": [
    {
      "level": 1,
      "name": "一等奖",
      "match_condition": 6,
      "fixed_prize": null,
      "prize_percentage": 1.0
    },
    {
      "level": 2,
      "name": "二等奖",
      "match_condition": 5,
      "fixed_prize": 10000.0,
      "prize_percentage": null
    },
    {
      "level": 3,
      "name": "三等奖",
      "match_condition": 4,
      "fixed_prize": 500.0,
      "prize_percentage": null
    },
    {
      "level": 4,
      "name": "四等奖",
      "match_condition": 3,
      "fixed_prize": 50.0,
      "prize_percentage": null
    }
  ]
}
```

#### 奖池配置
```json
{
  "jackpot": {
    "enabled": true,
    "initial_amount": 30000000.0,
    "contribution_rate": 0.30,
    "post_return_contribution_rate": 0.50,
    "return_rate": 0.20,
    "jackpot_fixed_prize": 1000000.0,
    "min_jackpot": 10000000.0
  }
}
```

**奖池配置参数说明**：
- `enabled`: 是否启用奖池机制
- `initial_amount`: 初始奖池金额
- `contribution_rate`: 第一阶段奖池注入比例
- `post_return_contribution_rate`: 第二阶段奖池注入比例
- `return_rate`: 销售方返还比例
- `jackpot_fixed_prize`: 头奖固定奖金（可选）
- `min_jackpot`: 最小奖池金额

### 模拟配置
```json
{
  "rounds": 1000,
  "players_range": [50000, 100000],
  "bets_range": [5, 15],
  "seed": null
}
```

**模拟配置参数说明**：
- `rounds`: 模拟轮数
- `players_range`: 每轮玩家数量范围 [最小值, 最大值]
- `bets_range`: 每个玩家投注次数范围 [最小值, 最大值]
- `seed`: 随机种子（可选，用于结果重现）

## 🧮 RTP计算规则和公式

### RTP基本概念
**RTP (Return to Player)** 是指返还给玩家的资金比例，是衡量游戏公平性和盈利性的核心指标。

```
RTP = 总派奖金额 / 总投注金额 × 100%
```

### 资金分配体系

#### 1. 分阶段资金分配
系统采用分阶段资金分配机制，确保销售方资金回收和奖池可持续性：

**第一阶段（销售方返还期间）**：
```
总投注金额 = 奖池注入金额 + 销售方返还金额 + 销售金额
```

**第二阶段（销售方返还完成后）**：
```
总投注金额 = 奖池注入金额 + 销售金额
```

#### 2. 资金分配公式

**第一阶段分配**：
- 奖池注入金额 = 总投注金额 × 第一阶段奖池注入比例
- 销售方返还金额 = 总投注金额 × 销售方返还比例
- 销售金额 = 总投注金额 - 奖池注入金额 - 销售方返还金额

**第二阶段分配**：
- 奖池注入金额 = 总投注金额 × 第二阶段奖池注入比例
- 销售金额 = 总投注金额 - 奖池注入金额

#### 3. 阶段转换条件
```
累计销售方返还金额 >= 初始奖池金额
```
当满足此条件时，系统自动从第一阶段转换到第二阶段。

### 奖池机制

#### 1. 奖池金额计算

奖池金额根据不同状态有两种计算方式：

**初始状态或头奖中出后**：
```
当前奖池金额 = 初始奖池金额
```

**玩家投注但未中头奖期间**：
```
当前奖池金额 = 初始奖池金额 + 累计奖池注入金额
```

**说明**：
- 每次有玩家中头奖时，奖池立即重置为初始金额
- 奖池只会增长，不会因派奖而减少（除了重置）
- 累计奖池注入金额在头奖中出后清零重新计算

#### 2. 头奖派发规则

**无固定奖金模式**：
```
单个头奖金额 = 当前奖池金额 / 头奖中奖人数
```

**有固定奖金模式**：
```
单个头奖金额 = (当前奖池金额 / 头奖中奖人数) + 固定奖金金额
```

#### 3. 奖池重置机制
当有玩家中头奖时：
- 奖池金额重置为初始奖池金额
- 销售方返还状态重置，重新开始分阶段逻辑
- 头奖中出次数累计计数

### 普通奖级计算

#### 1. 固定奖金奖级
```
奖级总派奖金额 = 中奖人数 × 固定奖金金额
```

#### 2. 比例奖金奖级
```
奖级总派奖金额 = 当前轮次总投注金额 × 奖金比例
单个中奖金额 = 奖级总派奖金额 / 中奖人数
```

### 中奖概率计算

#### 1. 彩票类游戏中奖概率
```
P(匹配k个号码) = C(选择数量, k) × C(总数量-选择数量, 选择数量-k) / C(总数量, 选择数量)
```

其中：
- C(n, k) = n! / (k! × (n-k)!) （组合数公式）
- 选择数量：玩家选择的号码数量
- 总数量：号码池总数量

#### 2. 各奖级中奖概率示例
以42选6彩票为例：
- 一等奖（6个匹配）：P = C(6,6) × C(36,0) / C(42,6) = 1 / 5,245,786
- 二等奖（5个匹配）：P = C(6,5) × C(36,1) / C(42,6) = 216 / 5,245,786
- 三等奖（4个匹配）：P = C(6,4) × C(36,2) / C(42,6) = 9,450 / 5,245,786

### 统计指标

#### 1. 玩家统计
```
总玩家数 = 所有轮次参与玩家数之和
总中奖人数 = 所有轮次中奖玩家数之和（按人计算，不重复计算）
总未中奖人数 = 总玩家数 - 总中奖人数
中奖率 = 总中奖人数 / 总玩家数 × 100%
```

#### 2. 投注统计
```
总投注次数 = 所有轮次投注次数之和
总投注金额 = 总投注次数 × 单注价格
平均每人投注次数 = 总投注次数 / 总玩家数
```

#### 3. 派奖统计
```
总派奖金额 = 普通奖级派奖金额 + 头奖派奖金额
普通奖级派奖金额 = Σ(各奖级派奖金额)
头奖派奖金额 = 头奖中出次数 × 平均头奖金额
```

### RTP计算实例

#### 示例配置
- 单注价格：¥10
- 第一阶段奖池注入比例：30%
- 第二阶段奖池注入比例：50%
- 销售方返还比例：20%
- 初始奖池：¥10,000

#### 计算过程
假设总投注金额为¥100,000：

**第一阶段**：
- 奖池注入：¥100,000 × 30% = ¥30,000
- 销售方返还：¥100,000 × 20% = ¥20,000
- 销售金额：¥100,000 - ¥30,000 - ¥20,000 = ¥50,000

**RTP计算**：
```
RTP = 总派奖金额 / 总投注金额 × 100%
```

如果总派奖金额为¥85,000：
```
RTP = ¥85,000 / ¥100,000 × 100% = 85%
```

### 实时RTP监控

#### 1. 轮次RTP
```
轮次RTP = 当前轮次派奖金额 / 当前轮次投注金额 × 100%
```

#### 2. 累计RTP
```
累计RTP = 累计派奖金额 / 累计投注金额 × 100%
```

#### 3. RTP趋势分析
系统提供最近N轮的RTP趋势，帮助分析RTP稳定性：
```
RTP方差 = Σ(轮次RTP - 平均RTP)² / 轮次数
RTP标准差 = √RTP方差
```

## 📊 性能特性

- **高效算法**: 使用集合操作优化号码匹配
- **内存管理**: 智能内存管理，支持大规模模拟
- **并发处理**: 支持多个模拟任务并发执行
- **实时监控**: 实时进度反馈和状态更新

## 🔒 安全特性

- **输入验证**: 严格的参数验证和边界检查
- **错误处理**: 完善的错误处理和恢复机制
- **资源限制**: 防止资源滥用的限制机制

## 📈 扩展性

- **插件化设计**: 支持自定义游戏类型
- **API扩展**: 开放的API接口，支持第三方集成
- **配置灵活**: 高度可配置的参数系统

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进项目。

## 📄 许可证

本项目采用MIT许可证。

## 📞 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue
- 发送邮件

---

**@numericalTools** - 让数值模拟验证更简单、更准确、更高效！
